apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: kernel-browser
  annotations:
    run.googleapis.com/ingress: all
    run.googleapis.com/ingress-status: all
spec:
  template:
    metadata:
      annotations:
        # Use second generation execution environment
        run.googleapis.com/execution-environment: gen2
        # Disable CPU throttling for consistent performance
        run.googleapis.com/cpu-throttling: "false"
        # Increase startup timeout
        run.googleapis.com/timeout: "3600"
        # Auto-scaling settings
        autoscaling.knative.dev/minScale: "1"
        autoscaling.knative.dev/maxScale: "10"
    spec:
      # Allow multiple concurrent requests (browser can handle multiple tabs/requests)
      containerConcurrency: 10
      # 1 hour timeout for long browser sessions
      timeoutSeconds: 3600
      # Service account for GCP access
      serviceAccountName: kernel-browser-sa
      containers:
      - name: kernel-browser
        image: gcr.io/PROJECT_ID/kernel-browser:latest
        ports:
        - name: http1
          containerPort: 8080
        resources:
          limits:
            # 4 CPU cores for smooth browser performance
            cpu: "4"
            # 8GiB memory (minimum required for Chromium + services)
            memory: "8Gi"
          requests:
            cpu: "2"
            memory: "4Gi"
        env:
        # Enable WebRTC for live viewing
        - name: ENABLE_WEBRTC
          value: "true"
        # Run as non-root user (Cloud Run requirement)
        - name: RUN_AS_ROOT
          value: "false"
        # Chrome optimizations for Cloud Run
        - name: CHROMIUM_FLAGS
          value: "--user-data-dir=/home/kernel/user-data --disable-dev-shm-usage --disable-gpu --start-maximized --disable-software-rasterizer --remote-allow-origins=* --no-sandbox --disable-setuid-sandbox --disable-features=VizDisplayCompositor"
        # Display configuration
        - name: DISPLAY_NUM
          value: "1"
        - name: HEIGHT
          value: "768"
        - name: WIDTH
          value: "1024"
        # ICE servers configuration for WebRTC (includes both STUN and TURN)
        - name: NEKO_ICESERVERS
          value: '[{"urls":["stun:global.stun.twilio.com:3478"]},{"urls":["turn:global.turn.twilio.com:3478?transport=udp"],"username":"464cefa09d5a8b4030b34b3faf15871b5efe0eef8331e9324f3f4f9144158ada","credential":"1Fm/UdpnNFbvfDPBtETUSZ4BhQsi0cubgLBdbScluPs="}]'
        # WebRTC configuration
        - name: NEKO_WEBRTC_TCPPORT
          value: "8081"
        - name: NEKO_WEBRTC_UDPPORT  
          value: "8082"
        # Proxy configuration (Oxylabs ISP proxy)
        - name: PROXY_ENABLED
          value: "true"
        - name: PROXY_SERVER
          value: "http://127.0.0.1:3128"
        # Optional: Google Cloud Storage bucket for recordings
        - name: GCS_BUCKET
          value: "kernel-browser-recordings"
        # API configuration
        - name: KERNEL_IMAGES_API_PORT
          value: "10001"
        - name: KERNEL_IMAGES_API_FRAME_RATE
          value: "10"
        - name: KERNEL_IMAGES_API_MAX_SIZE_MB
          value: "500"
        - name: KERNEL_IMAGES_API_OUTPUT_DIR
          value: "/tmp/recordings"
  traffic:
  - percent: 100
    latestRevision: true