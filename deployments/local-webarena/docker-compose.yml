version: '3.8'

services:
  kernel-browser:
    image: "kernel-browser:extended-webarena"
    container_name: "kernel-browser-extended-webarena"
    privileged: true
    shm_size: 2gb
    deploy:
      resources:
        limits:
          memory: 8192M
    ports:
      # Chrome DevTools Protocol (matches kernel-images default)
      - "9222:9222"
      # Recording API (matches kernel-images default)
      - "444:10001"
      # WebRTC client interface
      - "8000:8000"
      # Enhanced DevTools UI
      - "8001:8001"
      # Browser Agent Server HTTP API
      - "8080:8080"
      # WebRTC Neko interface
      - "8081:8081"
      # Browser Agent Server WebSocket
      - "8082:8082"
      # WebRTC UDP port range for local development
      - "57000-57100:57000-57100/udp"
    extra_hosts:
      # Route domains through host gateway (required for WebArena if WEBARENA_HOST_IP is set)
      - "host.docker.internal:host-gateway"
    environment:
      # Display settings
      - DISPLAY_NUM=1
      - HEIGHT=768
      - WIDTH=1024
      # WebRTC settings
      - ENABLE_WEBRTC=true
      - NEKO_WEBRTC_EPR=57000-57100
      - NEKO_WEBRTC_NAT1TO1=127.0.0.1
      # Run as kernel user (not root)
      - RUN_AS_ROOT=false
      # Chromium flags with persistent data directory and custom DevTools frontend
      # Note: --host-resolver-rules is dynamically generated in /chromium/flags based on WEBARENA_HOST_IP
      - CHROMIUM_FLAGS=--user-data-dir=/data/user-data --disable-dev-shm-usage --start-maximized --remote-allow-origins=* --no-sandbox --disable-setuid-sandbox --custom-devtools-frontend=http://localhost:8001/
      # WebArena Infrastructure Configuration (optional - load from evals/.env)
      # If set, container will route WebArena domains to specified IP and network
      - WEBARENA_HOST_IP=${WEBARENA_HOST_IP:-}
      - WEBARENA_NETWORK=${WEBARENA_NETWORK:-}
      # WebArena Site URLs (optional - for custom deployments)
      - SHOPPING=${SHOPPING:-http://onestopmarket.com}
      - SHOPPING_ADMIN=${SHOPPING_ADMIN:-http://onestopmarket.com/admin}
      - REDDIT=${REDDIT:-http://reddit.com}
      - GITLAB=${GITLAB:-http://gitlab.com}
      - WIKIPEDIA=${WIKIPEDIA:-http://wikipedia.org}
      - MAP=${MAP:-http://openstreetmap.org}
      - HOMEPAGE=${HOMEPAGE:-http://homepage.com}
    volumes:
      # Persist recordings in local directory
      - "./@mount/recordings:/recordings"
      # Mount Chromium flags directory (flags file is generated dynamically by init-container.sh based on WEBARENA_HOST_IP)
      - "./@mount/chromium-flags:/chromium"
      # Persist Chromium data across container restarts (set CHROMIUM_DATA_HOST env var to customize path)
      - "${CHROMIUM_DATA_HOST:-./@mount/chromium-data}:/data"
    tmpfs:
      - /dev/shm:size=2g
      - /tmp
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s  # Allow more time for startup

volumes:
  recordings:
    driver: local