# Development-optimized Dockerfile for Browser Operator DevTools
# This Dockerfile is designed for fast iterative builds during local development
# It caches expensive operations (fetch, sync) and allows quick rebuilds when code changes

# ==============================================================================
# Stage 1: DevTools Base (cached, rarely rebuilt)
# ==============================================================================
FROM --platform=linux/amd64 ubuntu:22.04 AS devtools-base

# Install required packages
RUN apt-get update && apt-get install -y \
    curl \
    git \
    python3 \
    python3-pip \
    python-is-python3 \
    wget \
    unzip \
    sudo \
    ca-certificates \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js 18.x
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - && \
    apt-get install -y nodejs && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /workspace

# Clone depot_tools (cached)
RUN git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
ENV PATH="/workspace/depot_tools:${PATH}"
ENV DEPOT_TOOLS_UPDATE=0

# Fetch devtools-frontend (expensive operation, cached)
RUN mkdir devtools
WORKDIR /workspace/devtools
RUN fetch devtools-frontend

# Build steps
WORKDIR /workspace/devtools/devtools-frontend

# Sync dependencies (cached)
RUN gclient sync
RUN /workspace/depot_tools/ensure_bootstrap

# Build standard DevTools first (cached)
RUN npm run build

# Add Browser Operator fork and checkout main branch
# This ensures the base has all Browser Operator customizations (ai_chat panel, etc.)
RUN git remote add upstream https://github.com/BrowserOperator/browser-operator-core.git
RUN git fetch upstream
RUN git checkout upstream/main

# Build Browser Operator version to ensure everything works
# This catches any build issues in the base layer
RUN npm run build

# Create marker file to indicate base is built
RUN touch /workspace/.devtools-base-built

# ==============================================================================
# Stage 2: Apply Browser Operator Changes (fast, iterative)
# ==============================================================================
FROM devtools-base AS devtools-local

# Copy local changes from browser-operator-core submodule FIRST
# This happens before checking out upstream, so we copy over the upstream code
COPY submodules/browser-operator-core/front_end /workspace/devtools/devtools-frontend/front_end
COPY submodules/browser-operator-core/agent-server /workspace/devtools/devtools-frontend/browser-agent-server

WORKDIR /workspace/devtools/devtools-frontend

# Force automated mode
RUN sed -i 's/AUTOMATED_MODE: false/AUTOMATED_MODE: true/' front_end/panels/ai_chat/core/BuildConfig.ts || true

# Force complete regeneration of build files by removing the entire out directory
# This ensures the build system picks up all changes in BUILD.gn files
RUN rm -rf out/Default

# Build Browser Operator version with local changes
# This will regenerate all build files from scratch based on the copied BUILD.gn
RUN npm run build

# Create marker file
RUN touch /workspace/.devtools-built

# ==============================================================================
# Stage 3: Nginx Server (optional, for standalone testing)
# ==============================================================================
FROM nginx:alpine AS devtools-server

# Copy the built DevTools frontend
COPY --from=devtools-local /workspace/devtools/devtools-frontend/out/Default/gen/front_end /usr/share/nginx/html

# Create simple nginx config
RUN echo 'server { \
    listen 8001; \
    root /usr/share/nginx/html; \
    location / { \
        try_files $uri $uri/ /index.html; \
    } \
    location /health { \
        return 200 "{\"status\":\"healthy\"}"; \
        add_header Content-Type application/json; \
    } \
}' > /etc/nginx/conf.d/default.conf

EXPOSE 8001

# Create health check file
RUN echo '{"status": "healthy", "service": "browser-operator-devtools"}' > /usr/share/nginx/html/health.json
